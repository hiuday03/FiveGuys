<section>
    <div class="pagetitle">
        <h1>Hóa đơn</h1>
        <nav>
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin/index}">Trang chủ</a></li>
                <li class="breadcrumb-item">Đơn hàng</li>
                <li class="breadcrumb-item active">Hóa đơn</li>
            </ol>
        </nav>
        <!--        <input type="text" ng-model="searchKeyword" ng-change="search()" placeholder="Search Bill..."-->
        <!--               class="form-control">-->
        <div class="row">
            <div class="col-10">
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home"
                            type="button" role="tab" aria-controls="home" aria-selected="true"
                            ng-click="resetFilter()">Tìm theo mã</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" t
                            ype="button" role="tab" aria-controls="profile" aria-selected="false"
                            ng-click="resetFilter()">Tìm kiếm
                            nâng cao</button>
                    </li>
                </ul>
            </div>
            <div class="col-2 d-flex justify-content-end">
                <button type="button" class="btn btn-outline-success mb-2 form-control" data-bs-toggle="modal"
                    data-bs-target="#modalExcel">
                    Xuất excel
                </button>
            </div>
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active col-md-3" id="home" role="tabpanel" aria-labelledby="home-tab">
                    <input type="text" ng-model="searchKeyword" ng-change="search()" placeholder="Nhập mã hóa đơn..."
                        class="form-control mt-2">
                </div>
                <div class="tab-pane fade" id="profile" role="tabpanel" aria-labelledby="profile-tab">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="fromDate">Từ ngày:</label>
                            <input type="date" id="fromDate" class="form-control" ng-model="fromDate">
                            <label for="toDate">Đến ngày:</label>
                            <input type="date" id="toDate" class="form-control" ng-model="toDate">
                        </div>
                        <div class="col-md-3">
                            <label for="fromDate">Loại hóa đơn:</label>
                            <select class="form-select" aria-label="Small select example" ng-model="typeBill">
                                <option value="">Chọn loại</option>
                                <option ng-value="1">Bán nhanh</option>
                                <option ng-value="2">Đặt hàng online</option>
                                <option ng-value="3">Bán giao hàng</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="fromDate">Trạng thái hóa đơn:</label>
                            <select class="form-select" aria-label="Small select example" ng-model="billStatus">
                                <option value="">Chọn trạng thái</option>
                                <option ng-value="1">Chờ xử lý</option>
                                <option ng-value="2">Đang giao hàng</option>
                                <option ng-value="3">Giao hàng thành công</option>
                                <option ng-value="4">Đã hủy</option>
                            </select>
                        </div>
                        <div class="col-md-1"></div>
                        <div class="col-md-2  mt-4">
                            <button type="button" class="btn btn-outline-primary mb-2 form-control"
                                ng-click="filter(fromDate, toDate, typeBill, billStatus)">Tìm kiếm
                            </button>
                            <button type="button" class="btn btn-outline-info mb-2 form-control"
                                ng-click="resetFilter()">Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!--  Begin code  -->
    <section class="section">
        <div class="alert border-success alert-dismissible fade show" role="alert" ng-show="showAlert">
            {{alertMessage}}
            <button type="button" class="btn-close" ng-click="closeAlert()" aria-label="Close"></button>
        </div>
        <!-- End Modal Add -->
        <div class="modal fade" id="modalUpdate" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" data-bs-toggle="tab" id="tabhome"
                                ng-click="showAddBillDetail(bill)" href="#home1">Thông tin hóa đơn</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" data-bs-toggle="tab" ng-click="showAddBillDetail('pd')"
                                href="#menu2">Danh sách sản phẩm</a>
                        </li>
                    </ul>
                    <div class="modal-body">
                        <div class="tab-content mt-3">
                            <div id="home1" class="container tab-pane active">
                                <div class="row">
                                    <label class="col-sm-2">Mã hóa đơn</label>
                                    <div class="col-sm-4">
                                        <input name="code" type="text" class="form-control bg-secondary-light"
                                            placeholder="Mã hóa đơn" ng-model="formUpdate.code" disabled
                                            ng-required="true">
                                    </div>
                                    <label class="col-sm-2">Tên khách hàng</label>
                                    <div class="col-sm-4">
                                        <!-- <input name="fullName" type="text" class="form-control bg-secondary-light"
                                            placeholder="Tên khách hàng" readonly
                                            ng-model="formUpdate.customerEntity.fullName" ng-required="true"> -->
                                        <div ng-if="formUpdate.customerEntity != null">
                                            <input name="fullName" type="text" class="form-control bg-secondary-light"
                                                placeholder="Tên khách hàng" disabled
                                                ng-model="formUpdate.customerEntity.fullName" ng-required="true">
                                        </div>
                                        <div ng-if="formUpdate.customerEntity == null">
                                            <input name="fullName" type="text" class="form-control bg-secondary-light"
                                                placeholder="Tên khách hàng" disabled ng-required="true"
                                                value="Khách lẻ">
                                        </div>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <label class="col-sm-2">Ngày đặt hàng</label>
                                    <div class="col-sm-4">
                                        <input name="createdAt" type="text" class="form-control bg-secondary-light"
                                            disabled ng-model="formUpdate.createdAt | date: 'dd-MM-yyyy HH:mm'"
                                            ng-required="true">
                                    </div>
                                    <label class="col-sm-2">Hình thức thanh toán</label>
                                    <div class="col-sm-4">
                                        <input name="paymentMethod" type="text" class="form-control bg-secondary-light"
                                            placeholder="Enter code" ng-model="formUpdate.paymentMethod.name" disabled
                                            ng-required="true">
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <label class="col-sm-2">Loại hóa đơn</label>
                                    <div class="col-sm-4" ng-switch="formUpdate.typeBill">
                                        <input name="typeBill1" type="text" ng-switch-when="1"
                                            class="form-control bg-secondary-light" value="Bán nhanh" disabled>
                                        <input name="typeBill2" type="text" ng-switch-when="2"
                                            class="form-control bg-secondary-light" value="Đặt hàng online" disabled>
                                        <input name="typeBill3" type="text" ng-switch-when="3"
                                            class="form-control bg-secondary-light" value="Bán giao hàng" disabled>
                                        <!--                                        <input name="code" type="text"-->
                                        <!--                                               class="form-control bg-secondary-light"-->
                                        <!--                                               placeholder="Enter code"-->
                                        <!--                                               ng-model="formUpdate.typeBill" readonly ng-required="true">-->
                                    </div>
                                    <label class="col-sm-2">Trạng thái</label>
                                    <div class="col-sm-4">
                                        <div ng-if="currentStatus == 1 || currentStatus == 2">
                                            <select class="form-select" aria-label="Small select example"
                                                ng-change="showNote(formUpdate.status)" ng-model="formUpdate.status">
                                                <option ng-value="1">Chờ xử lý</option>
                                                <option ng-value="2">Đang giao hàng</option>
                                                <option ng-value="3">Giao hàng thành công</option>
                                                <option ng-value="4">Đã hủy</option>
                                            </select>
                                        </div>

                                        <div ng-if="currentStatus == 3 || currentStatus == 4">
                                            <div ng-if="formUpdate.status == 3 && formUpdate.typeBill == 1">
                                                <input name="status4" type="text"
                                                    class="form-control bg-secondary-light" value="Thành công" disabled>
                                            </div>
                                            <div ng-if="formUpdate.status == 3 && formUpdate.typeBill != 1">
                                                <input name="status4" type="text"
                                                    class="form-control bg-secondary-light" value="Giao hàng thành công"
                                                    disabled>
                                            </div>
                                            <div ng-if="formUpdate.status == 4">
                                                <input name="status4" type="text"
                                                    class="form-control bg-secondary-light" value="Đã hủy" disabled>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- <div class="row mt-2">
                                    <div class="col-sm-2"></div>
                                    <div class="col-sm-4"></div>
                                    <label id="labelNote" class="col-sm-2">Lý do hủy</label>
                                    <div class="col-sm-4">
                                        <textarea id="areaNote" class="form-control" rows="2"
                                            ng-model="formUpdate.note"></textarea>
                                    </div>
                                </div> -->
                                <br>
                                <div class="accordion accordion-flush" id="accordionFlushExample"
                                    ng-if="formUpdate.typeBill != 1">
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="flush-headingOne">
                                            <button class="accordion-button collapsed" type="button"
                                                data-bs-toggle="collapse" data-bs-target="#flush-collapseOne"
                                                aria-expanded="false" aria-controls="flush-collapseOne">
                                                <h5>Thông tin giao hàng</h5>
                                            </button>
                                        </h2>
                                        <div id="flush-collapseOne" class="accordion-collapse collapse"
                                            aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample">
                                            <div>
                                                <div class="card card-body">
                                                    <div class="row mt-2">
                                                        <label class="col-sm-2">Tên người nhận</label>
                                                        <div class="col-sm-4">
                                                            <input name="code" type="text"
                                                                class="form-control bg-secondary-light"
                                                                placeholder="Tên người nhận"
                                                                ng-model="formUpdate.reciverName" disabled
                                                                ng-required="true">
                                                        </div>
                                                        <label class="col-sm-2">Số điện thoại</label>
                                                        <div class="col-sm-4">
                                                            <input name="createdAt" type="text"
                                                                class="form-control bg-secondary-light"
                                                                placeholder="Số điện thoại" disabled
                                                                ng-model="formUpdate.phoneNumber" ng-required="true">
                                                        </div>
                                                    </div>
                                                    <div class="row mt-2">
                                                        <label class="col-sm-2">Ngày giao hàng</label>
                                                        <div class="col-sm-4">
                                                            <input name="code" type="text"
                                                                class="form-control bg-secondary-light"
                                                                placeholder="Ngày giao hàng"
                                                                ng-model="formUpdate.deliveryDate | date: 'dd-MM-yyyy HH:mm'"
                                                                disabled ng-required="true">
                                                        </div>
                                                        <label class="col-sm-2">Phí giao hàng</label>
                                                        <div class="col-sm-4">
                                                            <input name="createdAt" type="text"
                                                                class="form-control bg-secondary-light"
                                                                placeholder="Phí giao hàng" disabled
                                                                ng-model="formUpdate.shippingFee" ng-required="true">
                                                        </div>
                                                    </div>
                                                    <div class="row mt-2">
                                                        <label class="col-sm-2">Địa chỉ</label>
                                                        <div class="col-sm-10">
                                                            <textarea id="address" type="text"
                                                                placeholder="Địa chỉ giao hàng"
                                                                class="form-control bg-secondary-light" disabled
                                                                ng-model="formUpdate.address"
                                                                ng-required="true">{{formUpdate.address}}</textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <hr>
                                <div class="row">
                                    <div class="col-7">

                                    </div>
                                    <div class="col-5" style="font-weight: bold; text-align: end">
                                        <div class="row mt-1">
                                            <label class="col-6">Tổng tiền: </label>
                                            <label class="col-6">{{tongTien | number:0}} đ</label>
                                        </div>
                                        <div class="row mt-1">
                                            <label class="col-6">Giảm giá hóa đơn: </label>
                                            <label class="col-6">{{giamGia | number:0}} đ</label>
                                        </div>
                                        <div class="row mt-1">
                                            <label class="col-6">Khách phải trả: </label>
                                            <label class="col-6">{{khachPhaiTra | number:0}} đ</label>
                                        </div>
                                        <div class="row mt-1">
                                            <label class="col-6">Khách đã thanh toán: </label>
                                            <label class="col-6">{{khachDaTra | number:0}} đ</label>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div ng-if="currentStatus == 1 || currentStatus == 2">
                                        <button ng-if="formUpdate.typeBill == 3 && currentStatus != 2"
                                            class="btn btn-primary" id="update">
                                            Cập nhật
                                        </button>
                                        <button class="btn btn-success" id="save"
                                            ng-click="updateStatus(formUpdate.status ,formUpdate)">Lưu
                                        </button>
                                    </div>
                                    <button type="button" class="btn btn-primary" id="submitEdit"
                                        ng-click="exportBill()">Xuất hóa đơn
                                    </button>
                                    <button class="btn btn-secondary" id="cancelEdit" data-bs-target="#modalDetail"
                                        data-bs-dismiss="modal">Đóng
                                    </button>
                                </div>
                            </div>
                            <div id="menu2" class="container tab-pane fade">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th scope="col">STT</th>
                                            <th scope="col">Tên sản phẩm</th>
                                            <th scope="col">Giá</th>
                                            <th scope="col">Số lượng</th>
                                            <th scope="col">Thành tiền</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr ng-repeat="bd in billDetails">
                                            <td class="col-1">{{$index + 1}}</td>
                                            <td class="col-6">{{bd.productDetail.product.name
                                                + ' - ' + bd.productDetail.color.name + ' - ' +
                                                bd.productDetail.size.name}}
                                            </td>
                                            <td class="col-2">{{bd.price | number:0}} đ</td>
                                            <td class="col-1">{{bd.quantity}}</td>
                                            <td class="col-2">{{bd.price * bd.quantity | number:0}} đ</td>
                                        </tr>
                                        <td colspan="8" ng-if="billDetails.length <= 0">
                                            <p style="text-align: center">No Bill detail</p>
                                        </td>
                                    </tbody>
                                </table>
                                <div class="row">
                                    <div class="col-7">

                                    </div>
                                    <div class="col-5" style="font-weight: bold; text-align: end">
                                        <div class="row mt-1">
                                            <label class="col-6">Tổng số sản phẩm</label>
                                            <label class="col-6">{{tongSoSanPham}}</label>
                                        </div>
                                        <div class="row mt-1">
                                            <label class="col-6">Tổng tiền: </label>
                                            <label class="col-6">{{tongTien | number:0}} đ</label>
                                        </div>
                                        <div class="row mt-1">
                                            <label class="col-6">Giảm giá hóa đơn: </label>
                                            <label class="col-6">{{giamGia | number:0}} đ</label>
                                        </div>
                                        <div class="row mt-1">
                                            <label class="col-6">Khách phải trả: </label>
                                            <label class="col-6">{{khachPhaiTra | number:0}} đ</label>
                                        </div>
                                        <div class="row mt-1">
                                            <label class="col-6">Khách đã thanh toán: </label>
                                            <label class="col-6">{{khachDaTra | number:0}} đ</label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>



                    </div>
                </div>
            </div>
        </div>
        </div>

        <!-- Begin Modal Update -->
        <div class="modal fade" id="modalExcel" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Xuất hóa đơn</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h5>Xuất danh sách hóa đơn ra file excel</h5>
                        <button class="btn btn-primary" ng-click="xuLyDataExportExcel()">Xác nhận</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Modal Update -->
        <div class="row">
            <div class="col-lg-12">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th scope="col">Mã</th>
                            <th scope="col">Ngày tạo</th>
                            <th scope="col">Khách hàng</th>
                            <th scope="col">Tổng tiền hàng</th>
                            <th scope="col">Giảm giá</th>
                            <th scope="col">Loại</th>
                            <th scope="col">Trạng thái</th>
                            <th scope="col">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr ng-repeat="bill in paper.items">
                            <td>{{bill.code}}</td>
                            <td>{{bill.createdAt | date:'dd-MM-yyyy HH:mm'}}</td>
                            <td>{{bill.customerEntity != null ? bill.customerEntity.fullName : 'Khách lẻ'}}</td>
                            <td>{{bill.totalAmount}}</td>
                            <td>{{bill.totalAmount - bill.totalAmountAfterDiscount}}</td>
                            <td class="col-1" ng-switch="bill.typeBill">
                                <span ng-switch-when="1">
                                    <div class="badge bg-secondary text-wrap" style="width: 5rem;">
                                        Bán nhanh
                                    </div>
                                </span>
                                <span ng-switch-when="2">
                                    <div class="badge text-wrap" style="width: 5rem;background-color: darkorchid;">
                                        Online
                                    </div>
                                </span>
                                <span ng-switch-when="3">
                                    <div class="badge bg-info text-wrap" style="width: 5rem;">
                                        Bán giao hàng
                                    </div>
                                </span>
                            </td>
                            <td class="col-2" ng-switch="bill.status">
                                <span ng-switch-when="1">
                                    <div class="badge bg-warning text-wrap">
                                        Chờ xử lý
                                    </div>
                                </span>
                                <span ng-switch-when="2">
                                    <div class="badge bg-primary text-wrap">
                                        Đang giao hàng
                                    </div>
                                </span>
                                <span ng-switch-when="3">
                                    <div class="badge bg-success text-wrap">
                                        Giao thành công
                                    </div>
                                </span>
                                <span ng-switch-when="4">
                                    <div class="badge bg-danger text-wrap">
                                        Đã hủy
                                    </div>
                                </span>
                            </td>
                            <td>
                                <button ng-if="bill.status == 1 || bill.status == 2" ng-click="edit(bill)" type="button"
                                    class="btn btn-info" data-bs-toggle="modal" data-bs-target="#modalUpdate"><i
                                        class="ri-edit-line"></i></button>
                                <button ng-if="bill.status == 3 || bill.status == 4" ng-click="edit(bill)" type="button"
                                    class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#modalUpdate"><i
                                        class="ri-eye-2-fill"></i></button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div class="row align-items-center">
                    <div class="col-md-1"> <!-- Điều chỉnh class col-md-6 tùy theo cỡ màn hình mong muốn -->
                        <select class="form-control" ng-model="paper.size" ng-change="changePageSize()">
                            <option value="selected">Xem mục</option>
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="col-md-11">
                        <nav aria-label="Page navigation example">
                            <ul class="pagination justify-content-end">
                                <li class="page-item">
                                    <button ng-click="paper.first()" class="page-link">First
                                    </button>
                                </li>
                                <li class="page-item">
                                    <button ng-click="paper.prev()" class="page-link">Previous
                                    </button>
                                </li>
                                <li class="page-item"><a class="page-link">{{paper.page + 1}} of
                                        {{paper.count}}</a>
                                </li>
                                <li class="page-item">
                                    <button ng-click="paper.next()" class="page-link">Next
                                    </button>
                                </li>
                                <li class="page-item">
                                    <button ng-click="paper.last()" class="page-link">Last
                                    </button>
                                </li>
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </section>

    
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <!--  End Code  -->
</section>