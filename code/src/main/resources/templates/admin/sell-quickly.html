<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Tabs</title>
    <link th:href="@{/assets/vendor/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/bootstrap-icons/bootstrap-icons.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/remixicon/remixicon.css}" rel="stylesheet">
    <link th:href="@{/assets/css/default-main.css}" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <script th:src="@{/assets/js/kendo.all.min.js}"></script>
    <script th:src="@{/assets/js/kendo-ui-license.js}"></script>
    <style>
        .container-fluid form {
            width: 400px;
            border: 1px solid rgb(82, 74, 235);
            border-radius: 4px;
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .container-fluid form input, .card form input {
            width: 100%;
            border: none;
            outline: none;
            box-shadow: none;
            font-size: 16px;
            font-weight: 600;
            padding-left: 35px;
        }

        .container-fluid form i, .icon-search {
            position: absolute;
            padding-left: 10px;
        }


        .product-list {
            display: none;
            position: absolute;
            background-color: #fff;
            width: 450px;
            left: 25px;
            top: 100%;
            box-shadow: 0 2px 4px 0 rgba(0,0,0,.2);
            padding: 8px 4px;
            height: 400px;
            overflow-y: scroll;
        }

        .product-list::-webkit-scrollbar {
            display: none;
        }

        .product {
            display: flex;
            align-items: center;
            cursor: pointer;
            overflow-y: scroll;
            padding: 6px 14px;
            margin-bottom: 4px;
        }

        .product:hover {
            background-color: rgba(0,112,244, 0.1);
        }

        .product img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 5px;
        }

        .product .p-details {
            padding-left: 15px;
        }

        .product .p-details h2 {
            font-size: 18px;
        }

        .product .p-details h1 {
            font-size: 20px;
            color: #0070F4;
            text-align: right;
        }

        .product .p-details h3 {
            font-size: 16px;
            color: #1d1d1d;
        }

        .product::-webkit-scrollbar {
            display: none;
        }

        .card {
            align-items: center;
            padding: 15px;
            height: 600px;
        }

        .card form {
            position: relative;
            width: 95%;
            border: 1px solid rgb(82, 74, 235);
            border-radius: 4px;
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .card form .icon-plus {
            position: absolute;
            right: 10px;
            font-size: 20px;
            font-weight: 600;
        }

        .input-discount {
            height: 100%;
            width: 100%;
            border: none;
            outline: none;
            font-size: 16px;
            border-bottom: 2px solid #4158d0;
            text-align: right;
        }

        .input-discount::-webkit-outer-spin-button,
        .input-discount::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        .input-discount[type=number] {
            -moz-appearance: textfield;
        }

        #pills-tab-footer {
            background-color: #e3f2fd;
            line-height: 35px;
        }

        .content-pay {
            width: 90%;
            height: 450px;
        }

        .horizontal-list {
            list-style: none;
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 0;
        }
        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        input[type=number] {
            -moz-appearance: textfield;
        }

    </style>
</head>
<body>
<div ng-app="sell-quickly" ng-controller="sell-quickly-ctrl" class="tab-content" id="tab-page">
    <div class="tab-pane fade show active" id="sell-quickly" role="tabpanel" aria-labelledby="sell-quickly">
        <nav class="navbar bg-primary">
            <div class="container-fluid justify-content-start">
                <div class="form-group has-search">
                    <span class="fa fa-search form-control-feedback"></span>
                    <form>
                        <i class="ri-search-line"></i>
                        <input id="search-product" type="text" class="form-control" placeholder="Search product" >
                    </form>
                    <div id="item-list" class="row product-list">
                        <div ng-repeat="item in products" class="product" ng-click="addProductCart(selectedItem, item.id)">
                            <img class="col-3" ng-src="{{item.productDetail[0].path}}" alt="">
                            <div class="col-7 p-details">
                                <h2>{{item.product.name}} {{item.product.material.name}}</h2>
                                <h3>Size: {{item.size.name}}</h3>
                                <h3>Quantity: {{item.quantity}}</h3>
                            </div>
                            <div class="col-2 p-details">
                                    <h1>{{item.price | number:'0':'symbol':'short'}}</h1>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="nav nav-pills ms-3">
                    <ul class="horizontal-list" kendo-panel-bar="tree"
                        k-data-source="treeData"
                        k-on-change="selectedItem = dataItem" >
                         <span k-template>
                    {{dataItem.name}} <i ng-show="selectedItem === dataItem" class="ri-close-fill" ng-click='removeBill(selectedItem)'></i>
                    </span>
                    </ul>
                    <button ng-click="addBill()" class="nav-link text-light" id="add-tab-button" type="button"><i class="ri-add-circle-line"></i></button></div>
            </div>
        </nav>
        <div class="tab-content pt-3 pb-3">
            <div class="row m-0">
                <div class="col-sm-8">
                    <table ng-if="selectedItem.cart.length > 0" class="table">
                        <tbody>
                            <tr ng-repeat="item in selectedItem.cart">
                                <td>{{item.product.name}} {{item.product.material.name}} Size {{item.size.name}}</td>
                                <td>
                                    <div class="d-flex" style="width: 40%">
                                        <button class="btn btn-outline-primary btn-sm px-2"
                                                ng-click="subtractQuantity(selectedItem, item)">
                                            <i class="ri-subtract-line"></i>
                                        </button>

                                        <input id="form1" min="1" name="quantity" ng-model="item.qty" type="number" ng-change="checkQuantityChange(selectedItem, item)"
                                               class="text-center mx-2 form-control form-control-sm" />

                                        <button class="btn btn-outline-primary btn-sm px-2"
                                                ng-click="addQuantity(selectedItem, item)">
                                            <i class="ri-add-line"></i>
                                        </button>
                                    </div>
                                </td>
                                <td style="line-height: 35px"><p class="m-0 fw-bold">{{item.price | number:'0':'symbol':'short'}}</p></td>
                                <td><button ng-click="removeProductCart(item.id, selectedItem)" class="btn btn-light border text-danger icon-hover-danger"><i class="ri-delete-bin-6-line"></i></button></td>
                            </tr>
                         </tbody>
                 </table>
                </div>

           <div class="col-sm-4">
                <div class="card">
                    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLabel">Thêm khách hàng</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body modal-lg">
                                    <form>
                                        <div class="row mb-3">
                                            <label for="inputfullName" class="col-sm-2 col-form-label">Tên khách hàng</label>
                                            <div class="col-sm-10">
                                                <input id="inputfullName" type="text" class="form-control">
                                            </div>
                                        </div>
                                        <div class="row mb-3">
                                            <label for="inputPhone" class="col-sm-2 col-form-label">Điện thoại</label>
                                            <div class="col-sm-10">
                                                <input id="inputPhone" type="number" class="form-control">
                                            </div>
                                        </div>
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                    <button type="button" class="btn btn-primary">Save changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                <form>
                  <i class="ri-search-line icon-search"></i>
                    <input id="search-client" type="text" class="form-control" placeholder="Search client">
                    <i class="ri-add-fill icon-plus"></i>
                </form>
                 <div class="content-pay justify-content-center mt-3">
                     <div class="row">
                    <div class="col-xl-5">
                       <p>Name</p>
                       </div>
                   <div class="col-xl-5">
                       <p class="float-end"></p>
                   </div>
                         <hr>
                    </div>
                    <div class="row">
                    <div class="col-xl-5">
                       <p>Point</p>
                     </div>
                    <div class="col-xl-5">
                        <p class="float-end">
                         </p>
                    </div>
                   <hr>
                    </div>
                    <div class="row">
                    <div class="col-xl-3">
                       <p>Items</p>
                    </div>
                        <div class="col-xl-3">
                            <p>{{selectedItem.itemQty}}</p>
                        </div>
                   <div class="col-xl-5">
                       <p class="float-end">
                           {{selectedItem.totalAmount | number:'0':'symbol':'short'}}
                       </p>
                   </div>
                   <hr>
                   </div>
                    <div class="row">
                        <div class="col-xl-5">
                            <p>Discount</p>
                        </div>
                  <div class="col-xl-5">
                        <p class="float-end">
                           <input type="number" class="input-discount">
                        </p>
                        </div>
                   <hr>
                    </div>
                <div class="row">
                    <div class="col-xl-5">
                       <p>Customer pay</p>
                        </div>
                    <div class="col-xl-5">
                        <p class="float-end">
                        </p>
                        </div>
                  <hr>
                   </div>
               </div>
           <div class="row w-100 justify-content-center">
            <div class="d-grid gap-2 mt-3">
                <button class="btn btn-primary" type="button">Pay</button>
            </div>
           </div>
        </div>
           </div>
              </div>
        </div>
    </div>
    <div class="tab-pane fade" id="shipment" role="tabpanel" aria-labelledby="shipment">asd</div>
</div>

<footer>
    <ul class="nav nav-pills navbar-light" id="pills-tab-footer" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-sell-quicly" data-bs-toggle="pill" data-bs-target="#sell-quickly" type="button" role="tab" aria-controls="pills-home" aria-selected="true" style="border-radius: unset;"><i class="ri-dvd-line"></i> Sell quickly</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-shipment" data-bs-toggle="pill" data-bs-target="#shipment" type="button" role="tab" aria-controls="pills-profile" aria-selected="false"><i class="ri-e-bike-2-line"></i> Shipment</button>
        </li>
    </ul>
</footer>

<script>
    const inputElement = document.getElementById('search-product');
    const hiddenElement = document.getElementById('item-list');
    inputElement.addEventListener('click', function() {
        hiddenElement.style.display = 'block';
    });

    document.addEventListener('click', function(event) {
        if (event.target !== inputElement && event.target !== hiddenElement) {
            hiddenElement.style.display = 'none';
        }
    });

    let app_sellQuickly = angular.module("sell-quickly", ["kendo.directives"]);
    app_sellQuickly.controller("sell-quickly-ctrl", function ($scope, $http){
        $scope.products = [];
        $scope.initialize = function () {
            $http.get("/api/productDetail").then(resp => {
                $scope.products = resp.data;
            })
        }
        $scope.initialize();
        // bill tab
        $scope.treeData = new kendo.data.HierarchicalDataSource({
            data: JSON.parse(localStorage.getItem("treeData")) || [
                {
                    code: 'HD1',
                    name: 'Bill 1',
                    createdAt: new Date(),
                    paymentDate: new Date(),
                    items: "",
                    totalAmount: 0,
                    totalAmountAfterDiscount: 0,
                    reciverName: "",
                    deliveryDate: new Date(),
                    shippingFee: 0,
                    address: "",
                    phoneNumber: "",
                    note: "",
                    status: 1,
                    cart: []
                }
            ]

        });


        function makeBill() {
            var uniqueId = $scope.treeData.data().length + 1;
            var bill = {
                code: 'HD' + uniqueId,
                name: 'Bill ' + uniqueId,
                createdAt: new Date(),
                paymentDate: new Date(),
                itemQty: "",
                totalAmount: 0,
                totalAmountAfterDiscount: 0,
                reciverName: "",
                deliveryDate: new Date(),
                shippingFee: 0,
                address: "",
                phoneNumber: "",
                note: "",
                status: 1,
                cart: []
            }
            return bill;
        };

        $scope.addBill = function () {
            var newbill = makeBill();
            $scope.treeData.add(newbill);
            localStorage.setItem("treeData", JSON.stringify($scope.treeData.data()));
        }

        $scope.removeBill = function (item) {
            var array = item.parent();
            var index = array.indexOf(item);

            // Check if the item being removed is not the first one
            if (index > 0) {
                array.splice(index, 1);

                // Set selectedItem to the previous item in the array
                $scope.selectedItem = undefined;
                localStorage.setItem("treeData", JSON.stringify($scope.treeData.data()));
            } else {
                return;
            }
        };

        $scope.addProductCart = function (selectedItem, id) {
            if (selectedItem == null) {
                alert("Please choose bill or create bill!")
                return;
            }
            var item = selectedItem.cart.find(item => item.id == id);
            if (item) {
                item.qty++;
                $scope.count(selectedItem);
            } else {
                $http.get('/api/productDetail/' + id).then(resp => {
                    resp.data.qty = 1;
                    selectedItem.cart.push(resp.data);
                    $scope.count(selectedItem);
                })
            }
        }



        $scope.removeProductCart = function (id, selectedItem) {
            var index = Object.values(selectedItem.cart).findIndex(item => item.id == id);
            if (index !== -1) {
                selectedItem.cart.splice(index, 1);
                $scope.count(selectedItem);
            }
        }

        $scope.subtractQuantity = function (selectedItem, item) {
            if (item.qty > 1) {
                item.qty--;
                $scope.count(selectedItem);
            }
        };

        $scope.addQuantity = function (selectedItem, item) {
            item.qty++;
            $scope.count(selectedItem);
        }

        $scope.checkQuantityChange = function (selectedItem, item) {
            if (isNaN(item.qty) || item.qty < 1 || !Number.isInteger(item.qty)) {
                item.qty = 1;
            }
            $scope.count(selectedItem);
        }

        $scope.count = function (selectedItem) {
            selectedItem.itemQty = selectedItem.cart.reduce((total, item) => total + item.qty, 0);

            selectedItem.totalAmount = selectedItem.cart.reduce((total, item) => total + item.qty * item.price, 0);
            localStorage.setItem("treeData", JSON.stringify($scope.treeData.data()));
        }


    });

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>