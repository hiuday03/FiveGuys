<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Tabs</title>
    <link th:href="@{/assets/vendor/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/bootstrap-icons/bootstrap-icons.css}" rel="stylesheet">
    <link th:href="@{/assets/vendor/remixicon/remixicon.css}" rel="stylesheet">
    <link th:href="@{/assets/css/default-main.css}" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
    <script th:src="@{/assets/js/kendo.all.min.js}"></script>
    <script th:src="@{/assets/js/kendo-ui-license.js}"></script>
    <style>
        .nav-link.tab {
            cursor: pointer;
        }
        .nav-link.tab.active {
            color: white;
        }

        /* Đổi màu nền thành màu trắng và màu chữ thành màu đen */
        .nav-link.tab.active {
            background-color: white;
            color: black !important;
        }

        .container-fluid form {
            width: 400px;
            border: 1px solid rgb(82, 74, 235);
            border-radius: 4px;
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .container-fluid form input, .card form input {
            width: 100%;
            border: none;
            outline: none;
            box-shadow: none;
            font-size: 16px;
            font-weight: 600;
            padding-left: 35px;
        }

        .container-fluid form i, .icon-search {
            position: absolute;
            padding-left: 10px;
        }

        #pills-tabContent {
            width: 100%;
            height: 630px;
            background-color: #dddddd;
        }

        .product-list {
            display: none;
            position: absolute;
            background-color: #fff;
            width: 400px;
            left: 25px;
            top: 100%;
            box-shadow: 0 2px 4px 0 rgba(0,0,0,.2);
            padding: 8px 4px;
            height: 400px;
            overflow-y: scroll;
        }

        .product-list::-webkit-scrollbar {
            display: none;
        }

        .product {
            display: flex;
            align-items: center;
            cursor: pointer;
            overflow-y: scroll;
            padding: 6px 14px;
            margin-bottom: 4px;
        }

        .product:hover {
            background-color: rgba(0,112,244, 0.1);
        }

        .product img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 5px;
        }

        .product .p-details {
            padding-left: 15px;
        }

        .product .p-details h2 {
            font-size: 18px;
        }

        .product .p-details h1 {
            font-size: 20px;
            color: #0070F4;
            text-align: right;
        }

        .product .p-details h3 {
            font-size: 16px;
            color: #1d1d1d;
        }

        .product::-webkit-scrollbar {
            display: none;
        }

        .card {
            align-items: center;
            padding: 15px;
            height: 600px;
        }

        .card form {
            position: relative;
            width: 95%;
            border: 1px solid rgb(82, 74, 235);
            border-radius: 4px;
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .card form .icon-plus {
            position: absolute;
            right: 10px;
            font-size: 20px;
            font-weight: 600;
        }

        .input-discount {
            height: 100%;
            width: 100%;
            border: none;
            outline: none;
            font-size: 16px;
            border-bottom: 2px solid #4158d0;
            text-align: right;
        }

        .input-discount::-webkit-outer-spin-button,
        .input-discount::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        /* Firefox */
        .input-discount[type=number] {
            -moz-appearance: textfield;
        }

        #pills-tab-footer {
            background-color: #e3f2fd;
            line-height: 35px;
        }

        .content-pay {
            width: 90%;
            height: 450px;
        }

        .horizontal-list {
            list-style: none;
            display: flex;
            flex-direction: row;
            align-items: center;
            padding: 0;
        }

    </style>
</head>
<body>
<div ng-app="sell-quickly" ng-controller="sell-quickly-ctrl" class="tab-content" id="tab-page">
    <div class="tab-pane fade show active" id="sell-quickly" role="tabpanel" aria-labelledby="sell-quickly">
        <nav class="navbar bg-primary">
            <div class="container-fluid justify-content-start">
                <div class="form-group has-search">
                    <span class="fa fa-search form-control-feedback"></span>
                    <form>
                        <i class="ri-search-line"></i>
                        <input id="search-product" type="text" class="form-control" placeholder="Search product" >
                    </form>
                    <div id="item-list" class="row product-list">
                        <div ng-repeat="item in products" class="product" ng-click="bills.setCart(selectedItem, item.id)">
                            <img class="col-3" ng-src="{{item.productDetail[0].path}}" alt="">
                            <div class="col-5 p-details">
                                <h2>{{item.product.name}}</h2>
                                <h3>Tồn: {{item.quantity}}</h3>
                            </div>
                            <div class="col-4 p-details">
                                <h1>{{item.price}}</h1>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="nav nav-pills ms-3">
                    <ul class="horizontal-list" kendo-panel-bar="tree"
                        k-data-source="treeData"
                        k-on-change="selectedItem = dataItem" ng-click="bills.showItem(selectedItem)">
                         <span k-template>
                    {{dataItem.name}} <i class="ri-close-fill" ng-click='bills.remove(dataItem.code)'></i>
                    </span>
                    </ul>
                    <button ng-click="bills.add()" class="nav-link text-light" id="add-tab-button" type="button"><i class="ri-add-circle-line"></i></button>                </div>
            </div>
        </nav>
        <div class="tab-content pt-3 pb-3">
            <div class="row m-0">
                <div class="col-sm-8">
                    <table class="table">
                       <thead>
                          <tr>
                             <th scope="col">Name</th>
                              <th>Action</th>
                          </tr>
                       </thead>
                        <tbody>
                            <tr ng-repeat="item in listItem">
                                <td>{{item.product.name}}</td>
                                <td>{{item.price}}</td>
                                <td>{{item.qty}}</td>
                                <td><button ng-click="bills.removeCart(item.id, selectedItem)" class="btn btn-light border text-danger icon-hover-danger">Xóa</button></td>
                            </tr>
                         </tbody>
                 </table>
                </div>
           <div class="col-sm-4">
                <div class="card">
                <form>
                  <i class="ri-search-line icon-search"></i>
                    <input id="search-client" type="text" class="form-control" placeholder="Search client">
                    <i class="ri-add-fill icon-plus"></i>
                </form>
                 <div class="content-pay justify-content-center mt-3">
                     <div class="row">
                    <div class="col-xl-5">
                       <p>Name</p>
                       </div>
                   <div class="col-xl-5">
                       <p class="float-end"></p>
                   </div>
                         <hr>
                    </div>
                    <div class="row">
                    <div class="col-xl-5">
                       <p>Point</p>
                     </div>
                    <div class="col-xl-5">
                        <p class="float-end">
                         </p>
                    </div>
                   <hr>
                    </div>
                    <div class="row">
                    <div class="col-xl-5">
                       <p>Total</p>
                    </div>
                   <div class="col-xl-5">
                       <p class="float-end">
                       </p>
                   </div>
                   <hr>
                   </div>
                    <div class="row">
                        <div class="col-xl-5">
                            <p>Discount</p>
                        </div>
                  <div class="col-xl-5">
                        <p class="float-end">
                           <input type="number" class="input-discount">
                        </p>
                        </div>
                   <hr>
                    </div>
                <div class="row">
                    <div class="col-xl-5">
                       <p>Customer pay</p>
                        </div>
                    <div class="col-xl-5">
                        <p class="float-end">
                        </p>
                        </div>
                  <hr>
                   </div>
               </div>
           <div class="row w-100 justify-content-center">
            <div class="d-grid gap-2 mt-3">
                <button class="btn btn-primary" type="button">Pay</button>
            </div>
           </div>
        </div>
           </div>
              </div>
        </div>
    </div>
    <div class="tab-pane fade" id="shipment" role="tabpanel" aria-labelledby="shipment">asd</div>
</div>

<footer>
    <ul class="nav nav-pills navbar-light" id="pills-tab-footer" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-sell-quicly" data-bs-toggle="pill" data-bs-target="#sell-quickly" type="button" role="tab" aria-controls="pills-home" aria-selected="true" style="border-radius: unset;"><i class="ri-dvd-line"></i> Sell quickly</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-shipment" data-bs-toggle="pill" data-bs-target="#shipment" type="button" role="tab" aria-controls="pills-profile" aria-selected="false"><i class="ri-e-bike-2-line"></i> Shipment</button>
        </li>
    </ul>
</footer>

<script>
    const inputElement = document.getElementById('search-product');
    const hiddenElement = document.getElementById('item-list');
    inputElement.addEventListener('click', function() {
        hiddenElement.style.display = 'block';
    });

    document.addEventListener('click', function(event) {
        if (event.target !== inputElement && event.target !== hiddenElement) {
            hiddenElement.style.display = 'none';
        }
    });

    let app_sellQuickly = angular.module("sell-quickly", ["kendo.directives"]);
    app_sellQuickly.controller("sell-quickly-ctrl", function ($scope, $http){
        $scope.products = [];
        $scope.employee = {};
        $scope.initialize = function () {
            $http.get("/api/productDetail").then(resp => {
                $scope.products = resp.data;
            })
            $http.get(`/employee/1`).then(resp => {
                $scope.employee = resp.data;
            })
        }
        $scope.initialize();
        // bill tab
        $scope.treeData = new kendo.data.HierarchicalDataSource({
            data: []
        });

        $scope.bills = {
            bill: [],
            add() {
                let billvalue = {
                    code: 'HD' + this.bill.length + 1,
                    name: 'Bill ' + this.bill.length + 1,
                    employee: $scope.employee,
                    cart: []
                }
                this.bill.push(billvalue);
                this.saveToLocalStorage();
            },
            remove(code) {
                let index = this.bill.findIndex(item => item.code == code);
                if (index !== -1) {
                    this.bill.splice(index, 1);
                    this.saveToLocalStorage();
                }
            },
            showItem(selectedItem) {
                const itemCode = selectedItem.code;
                const foundBill = this.bill.find(billItem => billItem.code === itemCode);
                $scope.listItem = foundBill.cart;
            },
            removeCart(id, selectedItem) {
                const itemCode = selectedItem.code;
                const foundBill = this.bill.find(billItem => billItem.code === itemCode);

                if (foundBill) {
                    // Tìm sản phẩm trong giỏ hàng của hóa đơn bằng ID
                    const index = foundBill.cart.findIndex(cartItem => cartItem.id === id);

                    if (index !== -1) {
                        // Xóa sản phẩm khỏi giỏ hàng của hóa đơn
                        foundBill.cart.splice(index, 1);

                        // Lưu thay đổi vào localStorage
                        this.saveToLocalStorage();
                    }
                }

                // Hiển thị danh sách sản phẩm còn lại trong giỏ hàng của hóa đơn
                this.showItem(selectedItem);
            },
            setCart(selectedItem, id) {
                const itemCode = selectedItem.code;
                const foundBill = this.bill.find(billItem => billItem.code === itemCode);

                if (foundBill) {
                    if (foundBill.cart.length === 0) {
                        $http.get('/api/productDetail/' + id).then(resp => {
                            resp.data.qty = 1;
                            foundBill.cart.push(resp.data);
                            this.saveToLocalStorage();
                        });
                    } else {
                        const foundCartItem = foundBill.cart.find(cartItem => cartItem.id === id);
                        if (foundCartItem) {
                            foundCartItem.qty++;
                            this.saveToLocalStorage();
                        } else {
                            $http.get('/api/productDetail/' + id).then(resp => {
                                resp.data.qty = 1;
                                foundBill.cart.push(resp.data);
                                this.saveToLocalStorage();
                            });
                        }
                    }
                }
                this.showItem(selectedItem);
            }
            ,
            saveToLocalStorage(){
                var json = JSON.stringify(angular.copy(this.bill));
                localStorage.setItem("bills",json);
                this.loadFromLocalStorage();
            },
            loadFromLocalStorage(){
                var json = localStorage.getItem("bills");
                this.bill = json ? JSON.parse(json) : [];
                $scope.treeData.data(this.bill);
            }

        }

        $scope.bills.loadFromLocalStorage();


    })

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>